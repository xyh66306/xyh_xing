<div class="panel panel-default panel-intro">

    <div class="panel-heading" style="background-color: #fff;">
        <div class="row">
            <div class="col-sm-6">
                <div class="item_header">可用金额</div>
                <div class="item_value">{$supply_info.money }</div>
            </div>
            <div class="col-sm-6">
                <div class="item_header">冻结金额</div>
                <div class="item_value">{$supply_info.freeze_money }</div>
            </div>
        </div>
    </div>

    <div class="panel-body">


        <!-- 步骤指示器 -->
        <div class="steps">
            <div class="step active-step">
                <div class="step-icon">1</div>
                <div class="step-label">转账信息</div>
            </div>
            <div class="step ">
                <div class="step-icon">2</div>
                <div class="step-label">账户信息</div>
            </div>
            <div class="step step_end">
                <div class="step-icon">3</div>
                <div class="step-label">完成</div>
            </div>
        </div>
            <!-- 第一步：转账信息 -->
            <div id="step1" class="active-step step-content">
                <form id="transferForm">
                    <div class="item">
                        <label class="block" for="account">转入账户</label>
                        <select id="account" name="account" class="form-control">
                            <option value="">请选择收款账户</option>
                            <option value="alipay">支付宝账户</option>
                            <option value="wxpay">微信账户</option>
                            <option value="bank">银行账户</option>
                        </select>
                    </div>
                    <div class="item">
                        <label class="block" for="amount">转账金额</label>
                        <div class="relative">
                            <input type="number" id="amount" class="form-control" placeholder="0.00" step="0.01" min="0">
                        </div>
                    </div>
                    <div class="item">
                        <label class="block" for="remark">转账备注</label>
                        <textarea id="remark" rows="3" class="form-control" placeholder="请输入转账用途说明（选填）"></textarea>
                    </div>
                    <button type="button" onclick="nextStep(2)" class="w-full nextbtn">下一步</button>
                </form>
            </div>

            <!-- 第二步：银行卡信息 -->
            <div id="step2" class="step-content bg-white">
                    <div class="item">
                        <label class="block" for="accountName">开户姓名</label>
                        <input type="text" id="accountName"
                            class="form-control"
                            placeholder="请输入开户姓名">
                    </div>
                    <div id="bankFormTemplate" class="paybox">
                        <div class="item">
                            <label class="block" for="bankName">开户银行</label>
                            <input type="text" id="bankName" class="form-control" placeholder="请输入开户银行">
                        </div>
                        <div class="item">
                            <label class="block" for="bankNumber">银行卡号</label>
                            <input type="text" id="bankNumber"
                                class="form-control"
                                placeholder="请输入银行卡号">
                        </div>
                        <div class="item">
                            <label class="block" for="branch">开户支行</label>
                            <input type="text" id="branch"
                                class="form-control"
                                placeholder="请输入开户支行（选填）">
                        </div>                    
                    </div>
                    <div id="ewmFormTemplate" class="paybox">
                        <div class="form-group">
                            <label class="control-label col-xs-12 col-sm-2">二维码:</label>
                            <div class="col-xs-12 col-sm-8">
                                
                                <div class="input-group">
                                    <input id="c-pay_ewm_image" data-rule="required" class="form-control" size="50" name="row[pay_ewm_image]" type="text" value="{$row.pay_ewm_image|htmlentities}">
                                    <div class="input-group-addon no-border no-padding">
                                    <button type="button" onclick="uploadImg()" id="faupload-pay_ewm_image" class="btn btn-danger faupload" data-input-id="c-pay_ewm_image" data-mimetype="image/gif,image/jpeg,image/png,image/jpg,image/bmp,image/webp" data-multiple="false" data-preview-id="p-pay_ewm_image"><i class="fa fa-upload"></i> 双击上传图片</button>
                                    </div>    
                                </div>
                                <ul class="row list-inline faupload-preview" id="p-ewm"></ul>
                            </div>
                        </div>
                    </div>
                    <div class="flex space-x-4">
                        <button type="button" onclick="prevStep(1)"
                            class="flex-1 bg-gray-200">上一步</button>
                        <!-- <button type="submit" class="btn btn-primary btn-embossed disabled">{:__('OK')}</button> -->
                        <button type="button" onclick="submitTransfer(3)"
                            class="flex-1 bg-blue-500">确认提交</button>
                    </div>
            </div>

            <!-- 第三步：完成 -->
            <div id="step3" class="step-content bg-white">
            <div class="form-group">
                <h2 class="text-xl font-bold mb-2 text-gray-800">转账申请已提交</h2>
                <p class="text-gray-600 mb-6">我们正在处理您的转账请求，预计1-3个工作日内到账</p>

                <div class="bg-gray-50 rounded-lg p-4 mb-6 text-left">
                    <div class="flex justify-between mb-2">
                        <span class="text-gray-500">转账金额</span>
                        <span class="font-medium" id="summary-amount">¥0.00</span>
                    </div>
                    <div class="flex justify-between mb-2">
                        <span class="text-gray-500">收款账户</span>
                        <span class="font-medium" id="summary-account">未选择</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-500">转账时间</span>
                        <span class="font-medium" id="summary-time">2025-08-28 15:55:03</span>
                    </div>
                </div>

                <button class="w-full bg-blue-500">完成</button>
                </div>    
            </div>
    </div>
</div>


<script>
    let currentStep = 1;
    const transferData = {};

    function uploadImg(){
        require(['upload'], function (Upload) {
            Upload.api.plupload($(".faupload"), function (data, ret) {
                let url = data.fullurl;
                $("#c-pay_ewm_image").val(url);
                transferData.pay_ewm_image = url;
            });
        });
    }

    function updateStepIndicator(step) {
        // 更新步骤指示器
        document.querySelectorAll('.steps .step').forEach((el, index) => {
            if (index === step - 1) {
                el.classList.add('active-step');
            } else {
                el.classList.remove('active-step');
            }
        });
    }

    function showStep(step) {
        document.querySelectorAll('.step-content').forEach(el => {
            el.classList.remove('active-step');
        });
        document.getElementById(`step${step}`).classList.add('active-step');
        updateStepIndicator(step);
    }

    function nextStep(step) {
        if (currentStep === 1) {
            // 验证第一步数据
            const account = document.getElementById('account').value;
            const amount = document.getElementById('amount').value;

            if (!account) {
                alert('请选择转入账户');
                return;
            }
            if (!amount || parseFloat(amount) <= 0) {
                alert('请输入有效的转账金额');
                return;
            }
            if(account == 'bank'){
                document.getElementById('bankFormTemplate').style.display = 'block';
                document.getElementById('ewmFormTemplate').style.display = 'none';
            } else {
                document.getElementById('bankFormTemplate').style.display = 'none';
                document.getElementById('ewmFormTemplate').style.display = 'block';
            }
            transferData.pay_type = account;
            transferData.amount = amount;
            transferData.remark = document.getElementById('remark').value;
        }
        currentStep = step;
        showStep(step);
    }

    function submitTransfer(step) {
        // 提交转账申请

        // const ewm = document.getElementById('c-pay_ewm_image').value;

        const bankName = document.getElementById('bankName').value;
        const bankNumber = document.getElementById('bankNumber').value;
        const accountName = document.getElementById('accountName').value;

        if (!accountName) {
            alert('请输入开户姓名');
            return;
        }

        if(transferData.pay_type == 'bank'){
            if (!bankName) {
                alert('请选择开户银行');
                return;
            }
            if (!bankNumber || bankNumber.length < 16) {
                alert('请输入有效的银行卡号');
                return;
            }
        } else {
            if (!transferData.pay_ewm_image) {
                alert('请上传转账二维码');
                return;
            }
        }

        transferData.bank_name = bankName;
        transferData.bank_account = bankNumber;
        transferData.username = accountName;
        transferData.bank_zhihang = document.getElementById('branch').value;

        // 更新第三步的摘要信息
        document.getElementById('summary-amount').textContent = `¥${parseFloat(transferData.amount).toFixed(2)}`;
        document.getElementById('summary-account').textContent = getAccountName(transferData.pay_type);
        document.getElementById('summary-time').textContent = new Date().toLocaleString();

        Fast.api.ajax({
            url: 'supply/tmoney/txadd',
            dataType: 'json',
            data: transferData,
            cache: false
        },function (ret) {
            if(ret.length > 0){
               Toastr.error(ret.msg); 
            }
        }, function (ret) {
            Toastr.error(ret.msg);
        });

        currentStep = step;
        showStep(step);
        alert('转账申请已提交');
    }

    function prevStep(step) {
        currentStep = step;
        showStep(step);
    }

    function getAccountName(account) {
        const accounts = {
            'alipay': '支付宝账户',
            'bank': '银行账户',
            'wxpay': '微信账户'
        };
        return accounts[account] || account;
    }


    // 初始化
    document.addEventListener('DOMContentLoaded', () => {
        updateStepIndicator(1);
    });
</script>


<style>
    .item_header {
        margin-bottom: 4px;
        color: rgba(0, 0, 0, .45);
        font-size: 14px;
    }

    .item_value {
        color: rgba(0, 0, 0, .85);
        font-size: 24px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
    }

    .step-content {
        display: none;
    }

    .active-step {
        display: block;
    }

    .steps {
        display: flex;
    }

    .step {
        display: flex;
        flex: 1 1;
        align-items: center;
        position: relative;
        z-index: 999;
        background-color: #fff;
    }

    .step .box {
        display: flex;
        flex: 1 1;
        align-items: center;
        position: relative;
        z-index: 999;
        background-color: #fff;
    }

    .step-icon {
        width: 32px;
        height: 32px;
        background: #fff;
        border-radius: 50%;
        overflow: hidden;
        color: #666;
        font-size: 16px;
        text-align: center;
        line-height: 200%;
        border: rgba(0, 0, 0, .25) 1px solid;
    }

    .active-step .step-icon {
        width: 32px;
        height: 32px;
        background: #1890ff;
        border-radius: 50%;
        overflow: hidden;
        color: #fff;
        font-size: 16px;
        text-align: center;
        line-height: 200%;
    }

    .step-label {
        margin-left: 10px;
        color: rgba(0, 0, 0, .85);
        position: relative;
    }

    .step-label::after {
        position: absolute;
        z-index: 1;
        top: 10px;
        right: -110px;
        display: block;
        width: 99px;
        height: 1px;
        background: #f0f0f0;
        content: "";
    }

    .step_end .step-label::after {
        display: none;
    }

    .step-content {
        display: none;
        width: 500px;
        margin: 40px auto 0;
    }

    .step-content.active-step {
        display: block;
    }

    .item {
        display: flex;
        align-items: center;
        padding:5px 0;
    }

    .item label {
        flex: 0 0 100px;
        height:35px;
        line-height:35px;
    }
    .item label {
        flex: 0 0 100px;
        height:35px;
        line-height:35px;
    }    
    .w-full {
        width:300px;
        height:35px;
        line-height:35px;
    }
    #remark {
        width:300px;
        min-height:60px;
    }

    .nextbtn {
        width: 100%;
        height: 50px;
        background: #1890ff;
        border:none;
        color:#fff;
        line-height: 50px;
        cursor: pointer;
        margin-top: 30px;
    }

    .bg-gray-200 {
        background-color: #f0f0f0;
        width: 200px;
        height: 40px;
        line-height: 40px;
        border-radius: 4px;
        border:none;
    }
    .bg-blue-500 {
        background-color: #1890ff;
        width: 200px;
        height: 40px;
        line-height: 40px;
        color:#fff;
        border-radius: 4px;
        border:none;

    }

    .space-x-4 {
        margin-top: 30px;
    }
    .paybox {
        display: none;
        overflow: hidden;
    }
</style>